<!DOCTYPE html>
<!-- SPDX-License-Identifier: MIT -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Town Council Asset Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- MarkerCluster for chunked, clustered rendering at scale -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    :root { --sidebar-width: 26rem; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #e2e8f0; }
    .card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155; color: #f8fafc; }
    .legend-circle { width: 14px; height: 14px; border-radius: 50%; }
    .sidebar { background-color: #1e293b; width: var(--sidebar-width); }
    select, option { background-color: #0f172a; color: #f8fafc; }
    .badge { background:#0b3b61; border:1px solid #1e40af; color:#c7d2fe; padding:2px 8px; border-radius:9999px; font-size:12px; }
    /* Map heights */
    #map { min-height: 60vh; height: 60vh; }
    @media (min-width: 768px) { #map { height: 100%; min-height: auto; } }

    /* Scrollable table in sidebar */
    .table-scroll { max-height: 40vh; overflow-y: auto; overscroll-behavior: contain; }
    @media (min-width: 1024px) { .table-scroll { max-height: calc(100vh - 24rem); } }

    /* Leaflet popup custom styling */
    .tc-popup .leaflet-popup-content { margin: 0; }
    .tc-popup .content { padding: 12px; max-height: 50vh; overflow-y: auto; }
    @media (min-width: 768px) { .tc-popup .content { max-height: 60vh; } }
    .tc-popup .badge { background:#0b3b61; border:1px solid #1e40af; color:#c7d2fe; padding:2px 8px; border-radius:9999px; font-size:12px; }
    .tc-popup .btn { display:inline-block; padding:6px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e2e8f0; }

    /* Presentation HUD */
    .hud { pointer-events:none; }
    .hud .tile { pointer-events:auto; background:rgba(30,41,59,0.9); border:1px solid #334155; }
    .hidden-important { display:none !important; }

    /* Tiny helper */
    .progress { height: 4px; background: #334155; }
    .progress > div { height: 100%; background: #22c55e; width: 0%; transition: width .2s; }

    /* Segmented control */
    .seg { display:inline-flex; border:1px solid #334155; border-radius:10px; overflow:hidden; }
    .seg button { padding:6px 10px; font-size:12px; color:#cbd5e1; }
    .seg button.active { background:#0b3b61; color:#e2e8f0; }

    /* === Cyber-style separators & glow accents === */
    :root { --acc1:#f59e0b; --acc1-glow:#fb923c; }
    .card{ position:relative; }
    .card::after{ content:""; position:absolute; left:10px; right:10px; top:-1px; height:2px; border-radius:1px; background:linear-gradient(90deg, transparent 0, var(--acc1) 50%, transparent 100%); box-shadow:0 0 10px var(--acc1-glow), 0 0 3px var(--acc1); opacity:.9; }
    #kpi-ribbon .card:not(:first-child)::before,
    #kpi-cases  .card:not(:first-child)::before{ content:""; position:absolute; top:8px; bottom:8px; left:-8px; width:2px; border-radius:1px; background:linear-gradient(180deg, transparent 0, var(--acc1) 50%, transparent 100%); box-shadow:0 0 8px var(--acc1-glow), 0 0 2px var(--acc1); }
    .sidebar, .tile, .tc-popup .content{ box-shadow: inset 0 0 0 1px #334155, inset 0 0 24px rgba(245,158,11,.08); }
    .frame{ position:relative; border:1px solid #334155; background:rgba(2,6,23,.35); }
    .frame::after{ content:""; position:absolute; left:10px; right:10px; top:-1px; height:2px; border-radius:1px; background:linear-gradient(90deg, transparent 0, var(--acc1) 50%, transparent 100%); box-shadow:0 0 10px var(--acc1-glow), 0 0 3px var(--acc1); opacity:.9; }

    /* --- Resizable sidebar (desktop) --- */
    .resizer {
      position: absolute;
      right: -6px;            /* sits between sidebar (left) and map (right) */
      top: 0;
      width: 12px;
      height: 100%;
      cursor: col-resize;
      background: transparent;
      z-index: 10;
    }
    .resizer::after {
      content: "";
      position: absolute;
      right: 5px;
      top: 25%;
      width: 2px;
      height: 50%;
      border-radius: 1px;
      background: rgba(148,163,184,0.35); /* slate-400/35 */
      box-shadow: 0 0 8px rgba(148,163,184,0.25);
    }
    body.resizing {
      user-select: none;
      cursor: col-resize;
    }
  </style>
</head>
<body class="h-screen flex flex-col">
  <!-- Header Controls -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-900/70">
    <div class="flex items-center gap-3">
      <h1 class="text-lg md:text-xl font-bold">TC Asset Map</h1>
      <span id="basemap-label" class="text-xs text-slate-400 hidden md:inline">Basemap: Light</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-collapse" class="hidden md:inline-flex px-3 py-2 text-sm rounded border border-slate-600 hover:bg-slate-800">Toggle Panel</button>
      <button id="btn-basemap" class="px-3 py-2 text-sm rounded border border-slate-600 hover:bg-slate-800">Dark Map</button>
      <button id="btn-present" class="px-3 py-2 text-sm rounded border border-indigo-600 hover:bg-indigo-900">Presentation</button>
    </div>
  </header>

  <!-- Hierarchy Filter Bar -->
  <div class="px-4 py-3 border-b border-slate-700 bg-slate-900/60 grid grid-cols-1 lg:grid-cols-6 gap-3">
    <div>
      <label class="block text-xs text-slate-400 mb-1">Singapore</label>
      <input value="Singapore" disabled class="w-full bg-slate-800/60 border border-slate-600 rounded p-2 text-slate-200"/>
    </div>
    <div>
      <label class="block text-xs text-slate-400 mb-1">Town Council</label>
      <select id="sel-tc" class="w-full bg-slate-800/60 border border-slate-600 rounded p-2"></select>
    </div>
    <div>
      <label class="block text-xs text-slate-400 mb-1">Division</label>
      <select id="sel-division" class="w-full bg-slate-800/60 border border-slate-600 rounded p-2"></select>
    </div>
    <div>
      <label class="block text-xs text-slate-400 mb-1">Precinct</label>
      <select id="sel-precinct" class="w-full bg-slate-800/60 border border-slate-600 rounded p-2"></select>
    </div>
    <div>
      <label class="block text-xs text-slate-400 mb-1">Zone</label>
      <select id="sel-zone" class="w-full bg-slate-800/60 border border-slate-600 rounded p-2"></select>
    </div>
    <div>
      <label class="block text-xs text-slate-400 mb-1">Case Status</label>
      <div class="seg" id="case-filter">
        <button data-val="all" class="active">All</button>
        <button data-val="new">New</button>
        <button data-val="ack">Ack</button>
        <button data-val="deployed">Deployed</button>
        <button data-val="finished">Finished</button>
      </div>
    </div>
  </div>

  <!-- KPI Ribbon (desktop) -->
  <div id="kpi-ribbon" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 border-b border-slate-700 shadow-inner">
    <div class="card p-4 rounded-xl"><p class="text-sm text-slate-400">Total Blocks</p><p id="kpi-blocks" class="text-3xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-sm text-slate-400">Assets OK</p><p id="kpi-ok" class="text-3xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-sm text-slate-400">Due for Maintenance</p><p id="kpi-due" class="text-3xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-sm text-slate-400">Faulty Assets</p><p id="kpi-faulty" class="text-3xl font-extrabold">—</p></div>
  </div>
  <!-- Cases KPI Row -->
  <div id="kpi-cases" class="grid grid-cols-2 md:grid-cols-4 gap-4 px-4 pb-4 border-b border-slate-700">
    <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400">Cases: New</p><p id="kpi-c-new" class="text-2xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400">Cases: Acknowledged</p><p id="kpi-c-ack" class="text-2xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400">Cases: Deployed</p><p id="kpi-c-deployed" class="text-2xl font-extrabold">—</p></div>
    <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400">Cases: Finished</p><p id="kpi-c-finished" class="text-2xl font-extrabold">—</p></div>
  </div>

  <!-- HUD overlay for Presentation Mode -->
  <div id="hud" class="hud hidden fixed inset-x-0 top-16 z-30 mx-auto max-w-6xl px-4">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="tile rounded-xl p-4"><div class="text-xs text-slate-400">Total Blocks</div><div id="hud-blocks" class="text-3xl font-extrabold">—</div></div>
      <div class="tile rounded-xl p-4"><div class="text-xs text-slate-400">Assets OK</div><div id="hud-ok" class="text-3xl font-extrabold">—</div></div>
      <div class="tile rounded-xl p-4"><div class="text-xs text-slate-400">Due</div><div id="hud-due" class="text-3xl font-extrabold">—</div></div>
      <div class="tile rounded-xl p-4"><div class="text-xs text-slate-400">Faulty</div><div id="hud-faulty" class="text-3xl font-extrabold">—</div></div>
    </div>
    <div class="mt-3 flex gap-2 items-center">
      <button id="btn-cycle" class="tile px-3 py-2 rounded">Start cycle</button>
      <div class="progress flex-1 rounded overflow-hidden"><div id="progress-bar"></div></div>
      <span class="text-xs text-slate-400">Press <span class="font-semibold">P</span> to toggle presentation</span>
    </div>
  </div>

  <!-- Floating open button (mobile only) -->
  <button id="open-panel" class="md:hidden fixed bottom-4 right-4 z-30 px-4 py-3 rounded-full bg-indigo-600 text-white shadow-lg focus:outline-none focus:ring">Details</button>

  <div class="flex h-full md:flex-row flex-col relative">
    <!-- Backdrop for mobile drawer -->
    <div id="backdrop" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-40 z-10"></div>

    <!-- Sidebar / Inspector -->
    <aside id="sidebar" class="sidebar border-slate-700 overflow-y-auto z-20
      fixed md:static inset-y-0 right-0 w-11/12 max-w-sm md:w-[var(--sidebar-width)] md:max-w-none
      border-l md:border-r transform translate-x-full md:translate-x-0 transition-transform duration-300
      relative">
      <!-- Drag handle (desktop only) -->
      <div id="sidebar-resizer" class="hidden md:block resizer" aria-hidden="true"></div>

      <div class="p-4 border-b border-slate-600 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-slate-100">Inspector</h2>
          <p class="text-sm text-slate-400">Click a block to view details.</p>
        </div>
        <button id="close-panel" class="md:hidden text-slate-300 hover:text-white" aria-label="Close details">✕</button>
      </div>

      <div class="p-4 border-b border-slate-600">
        <!-- Filter by Asset Type -->
        <div class="mt-2">
          <label class="block text-sm font-medium mb-1 text-slate-300">Filter by Asset Type:</label>
          <select id="asset-filter" class="w-full bg-slate-800/60 border border-slate-600 rounded p-2">
            <option value="all">All</option>
            <option value="dry">Dry Riser</option>
            <option value="hose">Fire Hose Reel</option>
          </select>
        </div>

        <!-- Map Legend -->
        <details class="mt-4" open>
          <summary class="text-sm font-medium text-slate-300 cursor-pointer select-none">Legend</summary>
          <div class="mt-2 space-y-2 text-sm">
            <div class="flex items-center gap-2"><span class="legend-circle bg-green-500"></span><span>OK / Completed</span></div>
            <div class="flex items-center gap-2"><span class="legend-circle bg-yellow-400"></span><span>Acknowledged</span></div>
            <div class="flex items-center gap-2"><span class="legend-circle bg-blue-500"></span><span>Deployed</span></div>
            <div class="flex items-center gap-2"><span class="legend-circle bg-red-500"></span><span>New / Faulty</span></div>
          </div>
        </details>
      </div>

      <div id="block-info" class="p-4 space-y-4 text-sm"><!-- Dynamic block data goes here --></div>
    </aside>

    <!-- Map -->
    <div class="flex-1 md:ml-0"><div id="map" class="w-full"></div></div>
  </div>

  <script>
    // ==== MAP SETUP ====
    const map = L.map('map', { preferCanvas: true }).setView([1.3521, 103.8198], 12);

    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const darkTiles  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO' });

    // ==== UI ELEMENTS ====
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    const btnOpen = document.getElementById('open-panel');
    const btnClose = document.getElementById('close-panel');
    const btnCollapse = document.getElementById('btn-collapse');
    const btnBasemap = document.getElementById('btn-basemap');
    const basemapLabel = document.getElementById('basemap-label');
    const btnPresent = document.getElementById('btn-present');
    const hud = document.getElementById('hud');
    const kpiRibbon = document.getElementById('kpi-ribbon');
    const btnCycle = document.getElementById('btn-cycle');
    const progressBar = document.getElementById('progress-bar');

    const selTC = document.getElementById('sel-tc');
    const selDivision = document.getElementById('sel-division');
    const selPrecinct = document.getElementById('sel-precinct');
    const selZone = document.getElementById('sel-zone');
    const caseFilterEl = document.getElementById('case-filter');

    // Lightweight date formatter with relative days
    function formatDate(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return d;
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      const days = Math.floor((Date.now()-dt.getTime())/86400000);
      return `${yyyy}-${mm}-${dd} (${days}d ago)`;
    }

    function isMobile() { return window.innerWidth < 1024; }
    function openSidebar() { if (isMobile()) { sidebar.classList.remove('translate-x-full'); backdrop.classList.remove('hidden'); setTimeout(() => map.invalidateSize(), 300);} }
    function closeSidebar() { if (isMobile()) { sidebar.classList.add('translate-x-full'); backdrop.classList.add('hidden'); setTimeout(() => map.invalidateSize(), 300);} }
    btnOpen.addEventListener('click', openSidebar); btnClose?.addEventListener('click', closeSidebar); backdrop.addEventListener('click', closeSidebar);

    // Collapse/expand panel (desktop)
    let panelCollapsed = false;
    btnCollapse?.addEventListener('click', () => { panelCollapsed = !panelCollapsed; sidebar.classList.toggle('hidden-important', panelCollapsed); setTimeout(() => map.invalidateSize(), 200); });

    // Basemap toggle
    let darkMode = false;
    btnBasemap.addEventListener('click', () => { darkMode = !darkMode; if (darkMode) { map.removeLayer(lightTiles); darkTiles.addTo(map); btnBasemap.textContent = 'Light Map'; basemapLabel.textContent = 'Basemap: Dark'; } else { map.removeLayer(darkTiles); lightTiles.addTo(map); btnBasemap.textContent = 'Dark Map'; basemapLabel.textContent = 'Basemap: Light'; } });

    // Presentation mode
    let presenting = false; function setPresenting(on) { presenting = on; hud.classList.toggle('hidden', !on); kpiRibbon.classList.toggle('hidden', on); document.body.classList.toggle('presenting', on); sidebar.classList.toggle('hidden-important', on); setTimeout(() => map.invalidateSize(), 200); }
    btnPresent.addEventListener('click', () => setPresenting(!presenting)); window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'p') setPresenting(!presenting); });

    // ==== DEMO DATA (will be replaced by API in production) ====
    const blocks = [
      { id: "123A", lat: 1.3101, lng: 103.856, status: "ok", townCouncil: "Bishan–Toa Payoh Town Council", division: "Toa Payoh East", precinct: "Precinct 1", zone: "Zone A",
        summary: { dry: 2, hose: 5, faulty: 0, due: 0 },
        cases: [
          { id: "C-1001", assetId: "DR-123A-01", type: "Dry Riser", status: "finished", createdAt: "2025-07-30" }
        ],
        assets: [
          { id: "DR-123A-01", type: "Dry Riser", location: "Stair 1", status: "OK", contractor: "ABC Fire Pte Ltd", lastService: "2025-07-15" },
          { id: "DR-123A-02", type: "Dry Riser", location: "Stair 2", status: "OK", contractor: "ABC Fire Pte Ltd", lastService: "2025-07-15" },
          { id: "FH-123A-01", type: "Fire Hose Reel", location: "L10 Lobby", status: "OK", contractor: "XYZ Safety Services", lastService: "2025-07-01" },
          { id: "FH-123A-02", type: "Fire Hose Reel", location: "L12 Lobby", status: "OK", contractor: "XYZ Safety Services", lastService: "2025-06-25" },
          { id: "FH-123A-03", type: "Fire Hose Reel", location: "L14 Lobby", status: "OK", contractor: "XYZ Safety Services", lastService: "2025-06-15" },
          { id: "FH-123A-04", type: "Fire Hose Reel", location: "L16 Lobby", status: "OK", contractor: "XYZ Safety Services", lastService: "2025-06-10" },
          { id: "FH-123A-05", type: "Fire Hose Reel", location: "L18 Lobby", status: "OK", contractor: "XYZ Safety Services", lastService: "2025-06-05" }
        ]
      },
      { id: "456B", lat: 1.3401, lng: 103.825, status: "warning", townCouncil: "Ang Mo Kio Town Council", division: "AMK Central", precinct: "Precinct 3", zone: "Zone C",
        summary: { dry: 1, hose: 5, faulty: 1, due: 1 },
        cases: [
          { id: "C-2001", assetId: "DR-456B-01", type: "Dry Riser", status: "new", createdAt: "2025-08-01" },
          { id: "C-2002", assetId: "FH-456B-03", type: "Fire Hose Reel", status: "ack", createdAt: "2025-08-02" }
        ],
        assets: [
          { id: "DR-456B-01", type: "Dry Riser", location: "Stair 1", status: "DUE", contractor: "Lion City Fire Systems", lastService: "2024-12-10" },
          { id: "FH-456B-01", type: "Fire Hose Reel", location: "L5 Lobby", status: "OK", contractor: "Lion City Fire Systems", lastService: "2025-05-10" },
          { id: "FH-456B-02", type: "Fire Hose Reel", location: "L8 Lobby", status: "OK", contractor: "Lion City Fire Systems", lastService: "2025-06-02" },
          { id: "FH-456B-03", type: "Fire Hose Reel", location: "L12 Lobby", status: "FAULTY", contractor: "Lion City Fire Systems", lastService: "2025-04-20" },
          { id: "FH-456B-04", type: "Fire Hose Reel", location: "L15 Lobby", status: "OK", contractor: "Lion City Fire Systems", lastService: "2025-07-01" },
          { id: "FH-456B-05", type: "Fire Hose Reel", location: "L18 Lobby", status: "OK", contractor: "Lion City Fire Systems", lastService: "2025-07-10" }
        ]
      },
      { id: "789C", lat: 1.3721, lng: 103.812, status: "faulty", townCouncil: "Jurong–Clementi Town Council", division: "Jurong West", precinct: "Precinct 5", zone: "Zone B",
        summary: { dry: 2, hose: 4, faulty: 2, due: 1 },
        cases: [
          { id: "C-3001", assetId: "DR-789C-01", type: "Dry Riser", status: "deployed", createdAt: "2025-08-03" }
        ],
        assets: [
          { id: "DR-789C-01", type: "Dry Riser", location: "Stair 1", status: "FAULTY", contractor: "SafeFlow Engineering", lastService: "2025-03-15" },
          { id: "DR-789C-02", type: "Dry Riser", location: "Stair 2", status: "OK", contractor: "SafeFlow Engineering", lastService: "2025-07-05" },
          { id: "FH-789C-01", type: "Fire Hose Reel", location: "L6 Lobby", status: "OK", contractor: "MetroFire Services", lastService: "2025-06-20" },
          { id: "FH-789C-02", type: "Fire Hose Reel", location: "L9 Lobby", status: "DUE", contractor: "MetroFire Services", lastService: "2025-02-18" },
          { id: "FH-789C-03", type: "Fire Hose Reel", location: "L12 Lobby", status: "OK", contractor: "MetroFire Services", lastService: "2025-06-01" },
          { id: "FH-789C-04", type: "Fire Hose Reel", location: "L15 Lobby", status: "OK", contractor: "MetroFire Services", lastService: "2025-07-12" }
        ]
      }
    ];

    const statusColors = { ok: 'green', warning: 'orange', faulty: 'red' };
    const caseColors = { new: '#ef4444', ack: '#f59e0b', deployed: '#3b82f6', finished: '#22c55e' };
    const casePriority = ['new', 'ack', 'deployed', 'finished'];

    // ==== KPI METRICS ====
    function computeMetrics(filteredBlocks) {
      const b = filteredBlocks ?? blocks;
      const totalBlocks = b.length;
      const allAssets = b.flatMap(x => x.assets);
      const faulty = allAssets.filter(a => a.status === 'FAULTY').length;
      const due = allAssets.filter(a => a.status === 'DUE').length;
      const ok = allAssets.length - faulty - due;
      const allCases = b.flatMap(x => x.cases || []);
      const cNew = allCases.filter(c => c.status === 'new').length;
      const cAck = allCases.filter(c => c.status === 'ack').length;
      const cDep = allCases.filter(c => c.status === 'deployed').length;
      const cFin = allCases.filter(c => c.status === 'finished').length;
      return { totalBlocks, ok, due, faulty, cNew, cAck, cDep, cFin };
    }
    function setText(id, val){ const el = document.getElementById(id); if (el) el.textContent = val; }
    function updateKPIs(filtered){ const m = computeMetrics(filtered); setText('kpi-blocks', m.totalBlocks); setText('kpi-ok', m.ok); setText('kpi-due', m.due); setText('kpi-faulty', m.faulty); setText('hud-blocks', m.totalBlocks); setText('hud-ok', m.ok); setText('hud-due', m.due); setText('hud-faulty', m.faulty); setText('kpi-c-new', m.cNew); setText('kpi-c-ack', m.cAck); setText('kpi-c-deployed', m.cDep); setText('kpi-c-finished', m.cFin); }

    // ==== FILTER STATE (Hierarchy + Asset + Case) ====
    let currentFilter = 'all'; // asset type
    let currentCase = 'all';
    let fTC = 'all', fDiv = 'all', fPrec = 'all', fZone = 'all';

    function unique(list, key){ return Array.from(new Set(list.map(x => x[key]))); }
    function opt(el, arr){ el.innerHTML = '<option value="all">All</option>' + arr.sort().map(v=>`<option value="${v}">${v}</option>`).join(''); }

    function hydrateFilters(){
      const tc = unique(blocks, 'townCouncil'); opt(selTC, tc);
      const divisions = unique(blocks, 'division'); opt(selDivision, divisions);
      const prec = unique(blocks, 'precinct'); opt(selPrecinct, prec);
      const zones = unique(blocks, 'zone'); opt(selZone, zones);
    }

    function passesHierarchy(b){ return (fTC==='all'||b.townCouncil===fTC) && (fDiv==='all'||b.division===fDiv) && (fPrec==='all'||b.precinct===fPrec) && (fZone==='all'||b.zone===fZone); }
    function passesAsset(b){ return currentFilter==='all' || (currentFilter==='dry' && b.summary.dry>0) || (currentFilter==='hose' && b.summary.hose>0); }
    function passesCase(b){ if (currentCase==='all') return true; const cs = (b.cases||[]).map(c=>c.status); return cs.includes(currentCase); }

    // ==== DETAILS BUILDERS ====
    function buildBlockDetails(block) {
      const rowsAssets = block.assets.map(a => `
        <tr class='border-b border-slate-600'>
          <td class='py-1 pr-2'>${a.id}</td>
          <td class='py-1 pr-2'>${a.type}</td>
          <td class='py-1 pr-2'>${a.location}</td>
          <td class='py-1 pr-2'>${a.status}</td>
          <td class='py-1 pr-2'>${formatDate(a.lastService)}</td>
          <td class='py-1'>${a.contractor}</td>
        </tr>
      `).join('');

      const rowsCases = (block.cases||[]).map(c => {
        const nexts = [];
        if (c.status==='new') nexts.push({to:'ack', label:'Acknowledge'});
        if (['new','ack'].includes(c.status)) nexts.push({to:'deployed', label:'Deploy'});
        if (['new','ack','deployed'].includes(c.status)) nexts.push({to:'finished', label:'Finish'});
        const btns = nexts.map(n=>`<button class='px-2 py-1 text-xs rounded border border-slate-600 hover:bg-slate-800' data-action='setStatus' data-block='${block.id}' data-case='${c.id}' data-to='${n.to}'>${n.label}</button>`).join(' ');
        return `
          <tr class='border-b border-slate-600'>
            <td class='py-1 pr-2'>${c.id}</td>
            <td class='py-1 pr-2'>${c.assetId}</td>
            <td class='py-1 pr-2'>${c.type}</td>
            <td class='py-1 pr-2'><span class='px-2 py-0.5 rounded' style='background:${caseColors[c.status]}; color:#0f172a; font-weight:700;'>${c.status.toUpperCase()}</span></td>
            <td class='py-1 pr-2'>${c.createdAt}</td>
            <td class='py-1'>${btns||'-'}</td>
          </tr>`;
      }).join('');

      return `
        <div>
          <div class='flex items-center justify-between'>
            <h3 class='text-lg font-semibold text-white'>Block ${block.id}</h3>
            <span class='badge'>${block.townCouncil}</span>
          </div>
          <p class='text-sm text-slate-300 mt-1'>${block.division} • ${block.precinct} • ${block.zone}</p>
          <p class='text-sm text-slate-300'>Status: <span style='color:${statusColors[block.status]}; font-weight:700;'>${block.status.toUpperCase()}</span></p>

          <div class='mt-4 grid grid-cols-2 gap-2 text-sm text-slate-200'>
            <div>Dry Risers: ${block.summary.dry}</div>
            <div>Hose Reels: ${block.summary.hose}</div>
            <div>Faulty Assets: <span class='text-red-400'>${block.summary.faulty}</span></div>
            <div>Due for Check: <span class='text-yellow-300'>${block.summary.due}</span></div>
          </div>

          <div class='mt-4'>
            <h4 class='text-sm font-semibold mb-2 text-slate-200'>Cases</h4>
            <div class='overflow-x-auto table-scroll rounded-lg frame'>
              <table class='min-w-full text-left text-sm'>
                <thead class='bg-slate-800 text-slate-300 sticky top-0 z-10'>
                  <tr>
                    <th class='py-2 px-2'>Case ID</th>
                    <th class='py-2 px-2'>Asset</th>
                    <th class='py-2 px-2'>Type</th>
                    <th class='py-2 px-2'>Status</th>
                    <th class='py-2 px-2'>Created</th>
                    <th class='py-2 px-2'>Actions</th>
                  </tr>
                </thead>
                <tbody class='bg-slate-900'>${rowsCases || '<tr><td class="px-2 py-2" colspan="6">No cases.</td></tr>'}</tbody>
              </table>
            </div>
          </div>

          <div class='mt-6'>
            <h4 class='text-sm font-semibold mb-2 text-slate-200'>Assets & Contractors</h4>
            <div class='overflow-x-auto table-scroll rounded-lg frame'>
              <table class='min-w-full text-left text-sm'>
                <thead class='bg-slate-800 text-slate-300 sticky top-0 z-10'>
                  <tr>
                    <th class='py-2 px-2'>Asset ID</th>
                    <th class='py-2 px-2'>Type</th>
                    <th class='py-2 px-2'>Location</th>
                    <th class='py-2 px-2'>Status</th>
                    <th class='py-2 px-2'>Last Service</th>
                    <th class='py-2 px-2'>Contractor</th>
                  </tr>
                </thead>
                <tbody class='bg-slate-900'>${rowsAssets}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function buildPopup(block) {
      const shortRows = (block.cases||[]).slice(0, 5).map(c => `
        <tr>
          <td class='py-1 pr-2'>${c.id}</td>
          <td class='py-1 pr-2'>${c.type}</td>
          <td class='py-1 pr-2'>${c.status}</td>
        </tr>
      `).join('');

      return `
        <div class='content'>
          <div class='flex items-center justify-between'>
            <div>
              <div class='font-semibold'>Block ${block.id}</div>
              <div class='text-xs mt-0.5'>Managed by <span class='badge'>${block.townCouncil}</span></div>
              <div class='text-xs mt-0.5'>${block.division} • ${block.precinct} • ${block.zone}</div>
            </div>
            <div class='text-xs' style='color:${statusColors[block.status]}; font-weight:700;'>${block.status.toUpperCase()}</div>
          </div>
          <div class='mt-2 grid grid-cols-2 gap-2 text-xs'>
            <div>Dry: ${block.summary.dry}</div>
            <div>Hose: ${block.summary.hose}</div>
            <div>Faulty: ${block.summary.faulty}</div>
            <div>Due: ${block.summary.due}</div>
          </div>
          <div class='mt-3 border border-slate-700 rounded'>
            <table class='min-w-full text-left text-xs'>
              <thead class='bg-slate-800 text-slate-300 sticky top-0'>
                <tr><th class='py-1 px-2'>Case</th><th class='py-1 px-2'>Type</th><th class='py-1 px-2'>Status</th></tr>
              </thead>
              <tbody>${shortRows || '<tr><td class="px-2 py-2" colspan="3">No cases</td></tr>'}</tbody>
            </table>
          </div>
          <div class='mt-3 text-right'>
            <a href='#' id='open-details-${block.id}' class='tile px-3 py-2 rounded border border-slate-600'>Open details</a>
          </div>
        </div>
      `;
    }

    function markerColorFor(block){
      const cs = (block.cases||[]).map(c=>c.status);
      for (const k of casePriority){ if (cs.includes(k)) return caseColors[k]; }
      return statusColors[block.status];
    }

    // ==== SCALE: Viewport loader + clustering + chunked rendering ====
    const useCluster = !!L.markerClusterGroup; // true if plugin loaded
    const cluster = useCluster ? L.markerClusterGroup({ disableClusteringAtZoom: 17, spiderfyOnMaxZoom: true, chunkedLoading: true, chunkDelay: 30, maxClusterRadius: 50 }) : L.layerGroup();
    cluster.addTo(map);

    const markerIndex = new Map(); // block.id -> marker

    function throttle(fn, wait){ let last=0, timer=null; return function(...args){ const now=Date.now(); const remaining = wait - (now-last); if (remaining<=0){ clearTimeout(timer); timer=null; last=now; fn.apply(this,args); } else if (!timer){ timer=setTimeout(()=>{ last=Date.now(); timer=null; fn.apply(this,args); }, remaining);} } }

    function blocksInView(){
      const b = map.getBounds();
      return blocks.filter(x => b.contains([x.lat, x.lng]) && passesHierarchy(x) && passesAsset(x) && passesCase(x));
    }

    function createMarker(block){
      const marker = L.circleMarker([block.lat, block.lng], { renderer: L.canvas(), color: markerColorFor(block), radius: 8, fillOpacity: 0.9 });
      marker.on('click', () => {
        marker.bindPopup(buildPopup(block), { maxWidth: 420, className: 'tc-popup' }).openPopup();
        setTimeout(() => {
          const btn = document.getElementById(`open-details-${block.id}`);
          if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('block-info').innerHTML = buildBlockDetails(block); if (isMobile()) openSidebar(); attachCaseActions(); });
        }, 0);
      });
      return marker;
    }

    function clearLayer(){ if (useCluster) cluster.clearLayers(); else cluster.eachLayer(l=>cluster.removeLayer(l)); markerIndex.clear(); }

    function addMarkersChunked(items){
      const total = items.length; let i=0; progressBar && (progressBar.style.width = '0%');
      function step(){
        const batch = items.slice(i, i+300);
        batch.forEach(block => { const m = createMarker(block); markerIndex.set(block.id, m); cluster.addLayer(m); });
        i += batch.length;
        if (progressBar) progressBar.style.width = Math.min(100, Math.round((i/total)*100)) + '%';
        if (i < total){ window.requestIdleCallback ? requestIdleCallback(step) : setTimeout(step, 0); }
        else { setTimeout(()=>{ if (progressBar) progressBar.style.width = '0%'; }, 600); }
      }
      if (total>0) step();
    }

    const rerender = throttle(() => { clearLayer(); const vis = blocksInView(); addMarkersChunked(vis); updateKPIs(vis); }, 250);

    map.on('moveend zoomend', rerender);

    // Asset filter
    document.getElementById('asset-filter').addEventListener('change', (e) => { currentFilter = e.target.value; rerender(); });

    // Case filter segmented control
    caseFilterEl.addEventListener('click', (e)=>{ if (e.target.tagName !== 'BUTTON') return; [...caseFilterEl.children].forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentCase = e.target.dataset.val; rerender(); });

    // Hierarchy select handlers
    function wireSelect(sel, setter){ sel.addEventListener('change', (e)=>{ setter(e.target.value); rerender(); }); }
    wireSelect(selTC, v=>fTC=v);
    wireSelect(selDivision, v=>fDiv=v);
    wireSelect(selPrecinct, v=>fPrec=v);
    wireSelect(selZone, v=>fZone=v);

    function attachCaseActions(){
      const container = document.getElementById('block-info');
      if (!container) return;
      container.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action="setStatus"]');
        if (!btn) return;
        const bId = btn.dataset.block; const cId = btn.dataset.case; const to = btn.dataset.to;
        const b = blocks.find(x=>x.id===bId); if (!b) return;
        const c = (b.cases||[]).find(x=>x.id===cId); if (!c) return;
        c.status = to; // update status locally
        document.getElementById('block-info').innerHTML = buildBlockDetails(b);
        attachCaseActions(); // rebind
        rerender();
      }, { once: true });
    }

    // ==== PRESENTATION CYCLE ====
    let cycleIdx = 0; let cycleTimer = null;
    function focusBlock(b){ map.flyTo([b.lat, b.lng], 16, { duration: 1.2 }); setTimeout(()=>{ const m = markerIndex.get(b.id); if (m) m.fire('click'); }, 1200); }
    function startCycle(){ if (cycleTimer) return; const targets = blocks.filter(b => passesHierarchy(b) && (b.cases||[]).some(c=>c.status!=='finished')); if (targets.length===0) return; btnCycle.textContent='Stop cycle'; cycleTimer = setInterval(()=>{ focusBlock(targets[cycleIdx % targets.length]); cycleIdx++; }, 8000); focusBlock(targets[cycleIdx % targets.length]); cycleIdx++; }
    function stopCycle(){ if (!cycleTimer) return; clearInterval(cycleTimer); cycleTimer=null; btnCycle.textContent='Start cycle'; }
    btnCycle.addEventListener('click', () => { if (cycleTimer) stopCycle(); else startCycle(); });

    // ==== RESIZABLE SIDEBAR (desktop) ====
    const resizer = document.getElementById('sidebar-resizer');
    const rootStyle = document.documentElement.style;
    const MIN_W = 280;    // px
    const MAX_W = 820;    // px
    const LS_KEY = 'sidebarWidthPx';

    // Apply saved width on load (desktop only)
    (function applySavedWidth(){
      const saved = localStorage.getItem(LS_KEY);
      if (saved && window.innerWidth >= 768) {
        rootStyle.setProperty('--sidebar-width', saved + 'px');
        setTimeout(() => map.invalidateSize(), 100);
      }
    })();

    let dragActive = false;
    let sidebarLeft = 0;

    function clientXFromEvent(evt){
      if (evt.touches && evt.touches.length) return evt.touches[0].clientX;
      if (evt.changedTouches && evt.changedTouches.length) return evt.changedTouches[0].clientX;
      return evt.clientX;
    }

    function onDragMove(e) {
      if (!dragActive) return;
      const x = clientXFromEvent(e);
      const width = Math.max(MIN_W, Math.min(MAX_W, x - sidebarLeft));
      rootStyle.setProperty('--sidebar-width', width + 'px');
      // throttle map relayout
      if (typeof onDragMove._t !== 'number' || Date.now() - onDragMove._t > 50) {
        map.invalidateSize();
        onDragMove._t = Date.now();
      }
      e.preventDefault();
    }

    function onDragEnd() {
      if (!dragActive) return;
      dragActive = false;
      document.body.classList.remove('resizing');
      window.removeEventListener('mousemove', onDragMove);
      window.removeEventListener('mouseup', onDragEnd);
      window.removeEventListener('touchmove', onDragMove);
      window.removeEventListener('touchend', onDragEnd);
      // persist current width
      const computed = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width').trim();
      const px = computed.endsWith('px') ? parseFloat(computed) : null;
      if (px) localStorage.setItem(LS_KEY, String(px));
      setTimeout(() => map.invalidateSize(), 80);
    }

    function onDragStart(e) {
      if (window.innerWidth < 768) return; // desktop/tablet only
      const rect = sidebar.getBoundingClientRect();
      sidebarLeft = rect.left;
      dragActive = true;
      document.body.classList.add('resizing');
      window.addEventListener('mousemove', onDragMove, { passive: false });
      window.addEventListener('mouseup', onDragEnd);
      window.addEventListener('touchmove', onDragMove, { passive: false });
      window.addEventListener('touchend', onDragEnd);
      e.preventDefault();
    }

    resizer?.addEventListener('mousedown', onDragStart);
    resizer?.addEventListener('touchstart', onDragStart, { passive: false });

    // Re-apply saved width when crossing breakpoints
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) rootStyle.setProperty('--sidebar-width', saved + 'px');
      }
      setTimeout(() => map.invalidateSize(), 300);
    });

    // ==== INIT ====
    hydrateFilters();
    updateKPIs();
    rerender();
  </script>
</body>
</html>
